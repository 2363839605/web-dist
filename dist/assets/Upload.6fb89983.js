import{b9 as I,_,a1 as E,a as J,b as K,m as U,ck as Q,h as o,S as D,ae as x,C as G,G as X,I as H,a4 as R,al as A,n as Y,bP as V,a7 as Z,bc as ee,ak as j,ci as te,b5 as S,cl as ae,az as ne,cm as oe,cn as re,co as se,d as le,bD as ie}from"./index.739d1244.js";import{u as de,c as ce,d as ue}from"./index.ae1f1040.js";async function*pe(a,i,u){const d=new Set;async function n(){const[c,r]=await Promise.race(d);return d.delete(c),r}for(const c of i){const r=(async()=>await u(c,i))().then(s=>[r,s]);d.add(r),d.size>=a&&(yield await n())}for(;d.size;)yield await n()}const me={pending:"neutral",uploading:"info",backending:"info",success:"success",error:"danger"},ge=async a=>{let i=[];const u=async(d,n)=>{await new Promise((r,s)=>{const l=p=>{console.error(p),s(p)};if(d.isFile)d.file(p=>{const m=new File([p],n+p.name,{type:p.type});i.push(m),console.log(m),r({})},l);else if(d.isDirectory){const p=d.createReader(),m=()=>{p.readEntries(async h=>{for(let w=0;w<h.length;w++)await u(h[w],n+d.name+"/");r({}),h.length>0&&m()},l)};m()}})};return await u(a,""),i},he=a=>({name:a.name,path:a.webkitRelativePath?a.webkitRelativePath:a.name,size:a.size,progress:0,speed:0,status:"pending"});function fe(a,i){return new Promise((u,d)=>{const n=document.createElement("video");n.crossOrigin="anonymous",n.src=a,n.autoplay=!0,n.muted=!0,n.onloadedmetadata=function(){n.currentTime=n.duration*i;const c=function(){if(n.currentTime>=n.duration*i){n.removeEventListener("timeupdate",c);const r=document.createElement("canvas");r.width=n.videoWidth,r.height=n.videoHeight;const s=r.getContext("2d");if(s){s.drawImage(n,0,0,r.width,r.height);const l=r.toDataURL("image/webp");u(l),n.pause(),n.remove()}}};n.addEventListener("timeupdate",c),n.onabort=function(){d(new Error("Video loading aborted")),n.removeEventListener("timeupdate",c)}}})}function we(a,i,u){fe(a,u).then(async d=>{let n=d.split(","),c=n[0].match(/:(.*?);/)[1],r=atob(n[1]),s=r.length,l=new Uint8Array(s);for(;s--;)l[s]=r.charCodeAt(s);let p=new Blob([l],{type:c});await I.put("/fs/put",p,{headers:{"File-Path":encodeURIComponent(i),"As-Task":!1,"Content-Type":p.type||"application/octet-stream",Password:_()}})})}const ye=async(a,i,u,d=!1)=>{let n=new Date().valueOf(),c=0;const r=new FormData;r.append("file",i);const s=await I.put("/fs/form",r,{headers:{"File-Path":encodeURIComponent(a),"As-Task":d,"Content-Type":"multipart/form-data","Last-Modified":i.lastModified,Password:_()},onUploadProgress:l=>{if(l.total){const p=l.loaded/l.total*100|0;u("progress",p);const m=new Date().valueOf(),h=(m-n)/1e3;if(h>1){const k=(l.loaded-c)/h,P=(l.total-l.loaded)/k;u("speed",k),console.log(P),n=m,c=l.loaded}p===100&&u("status","backending")}}});if(s.code!==200)return new Error(s.message)},be=async(a,i,u,d=!1)=>{console.log("StreamUpload",a);let n=new Date().valueOf(),c=0;const r=await I.put("/fs/put",i,{headers:{"File-Path":encodeURIComponent(a),"As-Task":d,"Content-Type":i.type||"application/octet-stream","Last-Modified":i.lastModified,Password:_()},onUploadProgress:s=>{if(s.total){const l=s.loaded/s.total*100|0;u("progress",l);const p=new Date().valueOf(),m=(p-n)/1e3;if(m>1){const w=(s.loaded-c)/m,F=(s.total-s.loaded)/w;u("speed",w),console.log(F),n=p,c=s.loaded}l===100&&u("status","backending")}}});if(r.code!==200)return new Error(r.message)},ke=[{name:"Stream",upload:be,provider:/.*/},{name:"Form",upload:ye,provider:/.*/}],ve=()=>ke.filter(a=>a.provider.test(E.provider)),Fe=a=>{const i=J();return o(R,{w:"$full",spacing:"$1",rounded:"$lg",border:"1px solid $neutral7",alignItems:"start",p:"$2",get _hover(){return{border:`1px solid ${A()}`}},get children(){return[o(S,{css:{wordBreak:"break-all"},get children(){return a.path}}),o(x,{spacing:"$2",get children(){return[o(ae,{get colorScheme(){return me[a.status]},get children(){return i(`home.upload.${a.status}`)}}),o(S,{get children(){return[ne(()=>oe(a.speed)),"/s"]}})]}}),o(re,{w:"$full",trackColor:"$info3",rounded:"$full",get value(){return a.progress},size:"sm",get children(){return o(se,{get color(){return A()},rounded:"$md"})}}),o(S,{color:"$danger10",get children(){return a.msg}})]}})},Pe=()=>{const a=J();function i(t,e){ie(e+t).then(g=>{console.log(g),we(g.data.raw_url,e+"/.thumbnails/"+t+".webp",.03)})}const{pathname:u}=K(),{refresh:d}=de(),[n,c]=U(!1),[r,s]=U(!1),[l,p]=U(!1),[m,h]=Q({uploads:[]}),w=()=>m.uploads.every(({status:t})=>["success","error"].includes(t));let k,F;const P=async t=>{if(t.length!==0){for(let e=0;e<t.length;e++)t[e].name.endsWith(".rmvb")&&(t[e]=new File([t[e]],t[e].name,{type:"video/rmvb",lastModified:t[e].lastModified})),l()&&t[e].type.startsWith("video/")&&(!t[e].type.endsWith("mp4")||!t[e].type.endsWith("flv"))&&(t[e]=new File([t[e]],t[e].name.slice(0,t[e].name.lastIndexOf("."))+".mp4",{type:t[e].type,lastModified:t[e].lastModified}));s(!0);for(const e of t){const g=he(e);h("uploads",f=>[...f,g])}for await(const e of pe(3,t,q))console.log(e);d(void 0,!0)}},y=(t,e,g)=>{h("uploads",f=>f.path===t,e,g)},T=ve(),[L,N]=U(T[0]),q=async t=>{const e=t.webkitRelativePath?t.webkitRelativePath:t.name;y(e,"status","uploading");const g=le(u(),e);try{const f=await L().upload(g,t,(C,b)=>{y(e,C,b)},l());if(f)y(e,"status","error"),y(e,"msg",f.message);else if(y(e,"status","success"),y(e,"progress",100),!l()&&t.type.startsWith("video/")){let C=e.slice(e.indexOf("/")+1),b=g.slice(0,g.lastIndexOf(C));u()!=b?i(C,b):i(e,b)}}catch(f){console.error(f),y(e,"status","error"),y(e,"msg",f.message)}};return o(R,{w:"$full",pb:"$2",spacing:"$2",get children(){return o(D,{get when(){return!r()},get fallback(){return[o(x,{spacing:"$2",get children(){return[o(G,{colorScheme:"accent",onClick:()=>{h("uploads",t=>t.filter(({status:e})=>!["success","error"].includes(e))),console.log(m.uploads)},get children(){return a("home.upload.clear_done")}}),o(D,{get when(){return w()},get children(){return o(G,{onClick:()=>{s(!1)},get children(){return a("home.upload.back")}})}})]}}),o(X,{get each(){return m.uploads},children:t=>o(Fe,t)})]},get children(){return[o(H,{type:"file",multiple:!0,ref(t){const e=k;typeof e=="function"?e(t):k=t},display:"none",onChange:t=>{var e;P(Array.from((e=t.target.files)!=null?e:[]))}}),o(H,{type:"file",multiple:!0,webkitdirectory:!0,ref(t){const e=F;typeof e=="function"?e(t):F=t},display:"none",onChange:t=>{var e;P(Array.from((e=t.target.files)!=null?e:[]))}}),o(R,{w:"$full",justifyContent:"center",get border(){return`2px dashed ${n()?A():"$neutral8"}`},rounded:"$lg",onDragOver:t=>{t.preventDefault(),c(!0)},onDragLeave:()=>{c(!1)},onDrop:async t=>{var z,B,M,O;t.preventDefault(),t.stopPropagation(),c(!1);const e=[],g=Array.from((B=(z=t.dataTransfer)==null?void 0:z.items)!=null?B:[]),f=Array.from((O=(M=t.dataTransfer)==null?void 0:M.files)!=null?O:[]);let C=g.length;const b=[];for(let $=0;$<C;$++){const v=g[$].webkitGetAsEntry();v!=null&&v.isFile?e.push(f[$]):v!=null&&v.isDirectory&&b.push(v)}for(const $ of b){const W=await ge($);e.push(...W)}e.length===0&&Y.warning(a("home.upload.no_files_drag")),P(e)},spacing:"$4",h:"$56",get children(){return o(D,{get when(){return!n()},get fallback(){return o(V,{get children(){return a("home.upload.release")}})},get children(){return[o(V,{get children(){return a("home.upload.upload-tips")}}),o(Z,{w:"30%",get children(){return o(ee,{get value(){return L().name},onChange:t=>{N(T.find(e=>e.name===t))},get options(){return T.map(t=>({label:t.name,value:t.name}))}})}}),o(x,{spacing:"$4",get children(){return[o(j,{compact:!0,size:"xl",get["aria-label"](){return a("home.upload.upload_folder")},colorScheme:"accent",get icon(){return o(ce,{})},onClick:()=>{F.click()}}),o(j,{compact:!0,size:"xl",get["aria-label"](){return a("home.upload.upload_files")},get icon(){return o(ue,{})},onClick:()=>{k.click()}})]}}),o(te,{get checked(){return l()},onChange:()=>{p(!l())},get children(){return a("home.upload.add_as_task")}})]}})}})]}})}})};export{Pe as default};
